# webapp-cve-processor

## Prerequisites for building the application locally

- Should have `golang` installed
- Should have `postgres` installed
- Should have `flyway` installed
- Optionally, have `pgadmin4` installed to view the database in GUI

## Building the application

- `go run .`

## Key features:

- Made this application as a go module, so that dependencies can be maintained at exact versions, instead of pulling the latest automatically which provides stability during deployment
- Preventing duplicate JSON data to be inserted as part of [database migration](#database-migration), helps us with maintaining consistency of the database and incase, of app crash, already processed JSON data will not be stored again.

### Database Migration:

- Before running migration scripts, you need to setup your local postgres by running few scripts as Database admin(root postgres user - `postgres`)

  ```
  -- Connect to local PostgreSQL
  psql -U postgres

  -- Create the database
  CREATE DATABASE cve;

  -- Create a new user
  CREATE USER cve_user WITH PASSWORD 'your_secure_password';

  -- Grant privileges to the user
  GRANT ALL PRIVILEGES ON DATABASE cve TO cve_user;
  ```

- Now, run your flyway migration scripts to setup database objects, so that it can be ready to receive data from the go application
  ```
  flyway -configFiles=flyway.conf migrate
  ```
- Flyway migration scritps are version controlled. If you feel your database have significant changes and the changes can be inserted with the database version being incremented.
  - To acheive this, you need to create a new migration script with a incremented version number and apply the flyway migrate again.
- To delete the current applied migration and recreate

  ```
  flyway clean
  flyway -configFiles=flyway.conf migrate
  ```

- Few additional flyway commands

  ```
  // use repair if you want to update the database with new changes in the migration scripts, without cleaning out
  flyway -configFiles=flyway.conf repair

  // to check flyway migratation state
  flyway info
  ```

### Docker image

- The strategy is to build 2 docker images, one for the application and one for the migration. The migration image will run from init container and the application image will run as a normal container image.
- Application image - Employed multi-stage build and seperated build environment and runtime environemnt. This helps to create a leaner final image.
- Migration image - This will run migration scripts against the host machine's postgres and setup the database structure.

  ```
  // To build a multi-platform image
  docker buildx build --platform linux/amd64,linux/arm64 -t acc_name/repo_name:tag --push -f your_docker_file .

  // To clear the locally cached image while building
  docker buildx prune --all

  // To remove the docker image
  docker rmi imageid:tag
  ```

- host.docker.internal -> denotes the host machine
- localhost -> denotes the container itself as the local host when menitoned in an image
