#!/bin/sh

echo "Starting entrypoint.sh..."

# Function to check Istio sidecar readiness
check_sidecar_readiness() {
  local retries=5
  local count=0
  local success=0

  while [ $count -lt $retries ]; do
    echo "Waiting for Sidecar..."
    if curl -fsI http://127.0.0.1:15021/healthz/ready; then
      success=1
      break
    fi
    count=$((count + 1))
    sleep 3
  done

  return $success
}

# Wait for the Istio sidecar to be ready
if check_sidecar_readiness; then
  echo "Sidecar up, running main application..."
  ./cve-app
  x=$?
  echo "Main application exited with status $x"

  # Check if the main application failed
  if [ $x -ne 0 ]; then
    echo "Main application failed with status $x"
  fi

  # Signal Envoy proxy to shut down gracefully
  echo "Sending quitquitquit to Envoy..."
  curl -fsI -X POST http://127.0.0.1:15020/quitquitquit
  echo "Sent quitquitquit to Envoy"

  # Exit with the status code of the main command
  exit $x
else
  echo "Failed to verify sidecar readiness after multiple attempts, exiting..."
  exit 1
fi
